---
title: "Malaria Species Interference"
author: "Nicholas F. Brazeau"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    highlight: textmate
    theme: lumen
    toc: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide')
```

```{r}
remotes::install_github("OJWatson/icer")
library(icer)
source("~/Documents/GitHub/VivID_Epi/R/00-functions_basic.R")

#......................
# Import Data
#......................
dt <- readRDS("~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_recode_completecases.rds")
dtsrvy <- makecd2013survey(survey = dt)

# need weighed counts
data <- dtsrvy %>% 
  dplyr::mutate(pfmono =  ifelse(pfldh == 1 & pv18s == 0 & po18s == 0, 1, 0),
                pvmono =  ifelse(pfldh == 0 & pv18s == 1 & po18s == 0, 1, 0),
                pomono =  ifelse(pfldh == 0 & pv18s == 0 & po18s == 1, 1, 0),
                pfpv =  ifelse(pfldh == 1 & pv18s == 1 & po18s == 0, 1, 0),
                pfpo =  ifelse(pfldh == 1 & pv18s == 0 & po18s == 1, 1, 0),
                pvpo =  ifelse(pfldh == 0 & pv18s == 1 & po18s == 1, 1, 0),
                pfpvpo =  ifelse(pfldh == 1 & pv18s == 1 & po18s == 1, 1, 0)
  ) %>% 
  dplyr::summarise(
    "pf" = srvyr::survey_total(x=pfmono),
    "pv" = srvyr::survey_total(x=pvmono),
    "po" = srvyr::survey_total(x=pomono),
    "pf/pv" = srvyr::survey_total(x=pfpv),
    "pf/po" = srvyr::survey_total(x=pfpo),
    "pv/po" = srvyr::survey_total(x=pvpo),
    "pf/pv/po" = srvyr::survey_total(x=pfpvpo)
  ) %>% 
  dplyr::select(-c(dplyr::ends_with("_se")))



data.vec <- unlist(data)
# have to round 
data.vec <- round(data.vec, 0)

```

## ICER
We will use 50,000 iterations. 

### Indepdent Model for Interference 
```{r}

# assuming independence
ret.ind <- icer::cooccurence_test(data.vec,
                                  boot_iter = 5e4)




jpeg(filename = "~/Documents/GitHub/VivID_Epi/results/figures/icer_independence_model.jpg",
     width = 11, height = 8, units = "in", res=500)
ret.ind$plot$plot
graphics.off()


```


### Non-independence Model for Interference 
```{r}


# assuming interference
ret.interference <- icer::cooccurence_test(data.vec,
                                           density_func = icer:::interference, 
                                           k_12 = 0.5, k_13 = 2, k_23 = 1, # arb starting params
                                           boot_iter = 5e4)


jpeg(filename = "~/Documents/GitHub/VivID_Epi/results/figures/icer_interference_model.jpg",
     width = 11, height = 8, units = "in", res=500)
ret.interference$plot$plot
graphics.off()
```

#### Plots Overlaid
```{r}
cowplot::plot_grid(ret.ind$plot$plot, 
                   ret.interference$plot$plot, 
                   ncol = 1, align = "v")


jpeg(filename = "~/Documents/GitHub/VivID_Epi/results/figures/icer_overlaid.jpg",
     width = 11, height = 8, units = "in", res=500)

cowplot::plot_grid(ret.ind$plot$plot, 
                   ret.interference$plot$plot,
                   ncol = 1, labels = c("A", "B"),
                   align = "v")
                   
graphics.off()

```

```{r}
#-------------------------- 
# Housekeeping save out
#-------------------------- 
save(ret.ind, ret.interference,
     file = "~/Documents/GitHub/VivID_Epi/results/icer_interference_models.rda")

```