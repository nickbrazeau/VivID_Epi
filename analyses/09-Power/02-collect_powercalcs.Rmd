---
title: "Post-Hoc Power Analysis"
author: "Nicholas F. Brazeau"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    highlight: textmate
    theme: lumen
    toc: yes
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide')
```

```{r}
library(tidyverse)
# import data
power.files <- list.files("~/Documents/MountPoints/mountedMeshnick/Projects/VivID_Epi/analyses/09-Power/_rslurm_powercalc/", pattern = ".RDS", full.names = T)
power.files <- power.files[!grepl("params.RDS|f.RDS", power.files)]

# need to sort properly
power.files <- tibble::tibble(power.files = power.files, 
                              iteration = stringr::str_extract(basename(power.files), "[0-9]+")) %>% dplyr::mutate(iteration = as.numeric(iteration)) %>% 
  dplyr::arrange(iteration)

read_power_files <- function(path){
  ret <- readRDS(path)
  ret <- dplyr::bind_rows(ret)
  return(ret)
}



power.files.ret <- lapply(power.files$power.files, read_power_files) %>% 
  dplyr::bind_rows()
poweriters.ret <- readRDS("~/Documents/MountPoints/mountedMeshnick/Projects/VivID_Epi/analyses/09-Power/_rslurm_powercalc/params.RDS") 
poweriters.params.ret <- dplyr::bind_cols(poweriters.ret, power.files.ret)


```

## _Post-Hoc_ Power Analysis 

```{r, results='asis', fig.align='center', fig.width=8, fig.height=6}

poweriters.powercalc <- poweriters.params.ret %>% 
  dplyr::group_by(n, p, exp_prob, p0, RR) %>% 
  dplyr::summarise(
    power = mean(p1 < 0.05)
  )

df <- poweriters.powercalc %>%
  dplyr::mutate(beta = 1-power,
                expprob_f = factor(exp_prob))


PowerPlot <- ggplot(df, aes(x=beta, y=RR, color = expprob_f)) +
  geom_jitter(alpha=0.8) +
  geom_vline(aes(xintercept=0.2), colour="#de2d26", linetype="dashed") +
  ggtitle(label="Simulated Risk Ratio versus \n Type II Error (Complement of Power)") +
  xlab("Type II Error") + ylab("Risk Ratio") +
  xlim(0,0.5) + # once we fall off we don't care that much
  ylim(0, 3) + # not impressive to catch an RR of 5...
  scale_color_manual("Exposure Probability", values = c("#8214A0", "#005AC8", "#006E82")) +
  theme(plot.title = element_text(hjust = 0.5, face="bold", size=16),
        axis.title = element_text(hjust = 0.5, size=14),
        axis.text = element_text(hjust = 0.5, size=13),
        axis.line = element_line("black", size = 0.75))


plot(PowerPlot)

jpeg(filename = "~/Documents/GitHub/VivID_Epi/results/figures/RR_glm_posthoc_powercalc.jpg", width = 11, height = 8, res = 250, units = "in")
plot(PowerPlot)
graphics.off()


```
