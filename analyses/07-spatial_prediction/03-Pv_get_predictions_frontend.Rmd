---
output: html_document
editor_options: 
  chunk_output_type: console
---
# Bayesian Hierarchial Spatial Model Predictions 

```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center', fig.width = 8, fig.height = 8)

```

```{r}
library(tidyverse)
library(CARBayes)
library(PrevMap)
library(ggspatial)
load("~/Documents/GitHub/VivID_Epi/data/map_bases/vivid_maps_bases.rda")
drccites <- readxl::read_excel("~/Documents/GitHub/VivID_Epi/data/map_bases/DRC_city_coordinates.xlsx") %>% 
  dplyr::mutate(latnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,1] ),
                longnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,2] ) 
                )

```
  
## Spatial Predictions
Fitted values are taken from the Hierarchial Bayesian Spatial Models that were previously fit and determined to be the best model choice by model fit (Deviance Information Criteria).

### Province Models
```{r}
# import data
DRCprov <- readRDS("~/Documents/GitHub/VivID_Epi/data/map_bases/vivid_DRCprov.rds")
provmodel <- readRDS("~/Documents/GitHub/VivID_Epi/analyses/07-spatial_prediction/prov_map_long_chains/Province_Bayes_Hierarchial_Model_longchain.rds")
provmodel <- provmodel[provmodel$name == "ICAR_covar", ] # best model

```

#### Fitted Values (Posterior Means)
```{r}
provs <- provmodel$data[[1]]$adm1name
provmodel.samples.fittedvalues <- provmodel$MCMC[[1]]$samples$fitted

provmodel.posteriormeans <- apply(provmodel.samples.fittedvalues, 2, mean)
```

```{r, results='asis'}
provmodel.posteriormeans <- cbind.data.frame(adm1name = provs, posteriormeanscounts = provmodel.posteriormeans) 
rownames(provmodel.posteriormeans) <- NULL

provmodel.posteriormeans %>% 
  dplyr::mutate_if(., is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv')))
```


```{r, results='asis'}
provmodel.posteriormeans <- cbind.data.frame(adm1name = provs, posteriormeansprev = provmodel.posteriormeans$posteriormeanscounts) 
provmodel.posteriormeans$posteriormeansprev <- provmodel.posteriormeans$posteriormeansprev/provmodel$data[[1]]$n
rownames(provmodel.posteriormeans) <- NULL

provmodel.posteriormeans %>% 
  dplyr::mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv')))
```




```{r}

#........................
# Bring it home
#........................
provmodelplotObjdf <- dplyr::left_join(DRCprov, provmodel.posteriormeans) 

provmodelplotObj <- ggplot() + 
  geom_sf(data = provmodelplotObjdf, aes(fill = posteriormeansprev), color = "#737373") +
   scale_fill_gradientn("Prevalence", colors = c("#FFEC00", "#FF0000")) +
  coord_sf(datum=NA) +  # to get rid of gridlines
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum)) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.3, fontface = "bold") +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))

jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ProvMap_postMeans.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(provmodelplotObj)
graphics.off()

```

```{r, results='asis'}
plot(provmodelplotObj)
```

#### Standard Errors
```{r}
provmodel.sd <- apply(provmodel.samples.fittedvalues, 2, sd)
provmodel.se <- provmodel.sd/sqrt(nrow(provmodel.samples.fittedvalues))

```

```{r, results='asis'}
provmodel.posteriorse <- cbind.data.frame(adm1name = provs, posteriorses = provmodel.se) 
rownames(provmodel.posteriorse) <- NULL

provmodel.posteriorse %>% 
  dplyr::mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
                options = list(
                  searching = T,
                  pageLength = 10,
                  dom = 'Bfrtip', 
                  buttons = c('csv')))
```

```{r}
provmodel.posteriorseplotdf <- dplyr::left_join(DRCprov, provmodel.posteriorse) 


provmodel.posteriorselotObj <- ggplot() +
  geom_sf(data = provmodel.posteriorseplotdf, 
          aes(fill = posteriorses), color = "#737373") +
    scale_fill_gradientn("Standard Error", colors = c("#FFEC00", "#FF0000")) +
  coord_sf(datum=NA) +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))

jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ProvMap_postSEs.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(provmodel.posteriorselotObj)
graphics.off()

```
```{r, results='asis'}
plot(provmodel.posteriorselotObj)
```


### Cluster Models 

### Fitted Values (Posterior Means)

```{r}
# A "pred.PrevMap" object list with the following components: logit; prevalence; odds; probit;exceedance.prob, corresponding to a matrix of the exceedance probabilities where each column corresponds to a specified value in thresholds; samples, corresponding to a matrix of the posterior samples at each prediction locations for the linear predictor; grid.pred prediction locations. Each of the three components logit, prevalence, odds and probit is also a list with the following components:
source("~/Documents/GitHub/VivID_Epi/R/00-functions_basic.R")
# read rds
# TODO fix this path
clstmodel <- readRDS("~/Desktop/VivID_Epi_old/analyses/07-spatial_prediction/_rslurm_Prevmap_predictions/results_0.RDS")
clstmodel.fitted <- expit(clstmodel[[1]]$samples)
clstmodel.coords <- clstmodel[[1]]$grid.pred
clstmodel.fitted.postmeans <- apply(clstmodel.fitted, 2, mean)

```

```{r, results='asis'}

clstmodel.fitted.postmeansdf <- data.frame(PrevPred = clstmodel.fitted.postmeans)
clstmodel.fitted.postmeansdf %>% 
  dplyr::mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv')))
```


```{r}
clstmodel.fitted.postmeans.raster <- 
  raster::rasterFromXYZ(cbind(clstmodel.coords[, "longnum"],
                              clstmodel.coords[, "latnum"],
                              clstmodel.fitted.postmeans),
                        crs="+proj=longlat +datum=WGS84 +no_defs")
  

ret.smrstr.m.df <-  data.frame(lon = clstmodel.fitted.postmeans.raster[,1], 
                               lat = clstmodel.fitted.postmeans.raster[,2], 
                               prev = clstmodel.fitted.postmeans.raster[,3])
ret.smrstr.m.plot <- ggplot() + 
  geom_raster(data = ret.smrstr.m.df, aes(lon, lat, fill = prev)) +
  scale_fill_gradientn("Prevalence", colors = c("#FFEC00", "#FF0000")) +
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum)) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.3, fontface = "bold") +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_postMeans.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(ret.smrstr.m.plot)
graphics.off()

```

```{r, results='asis'}
plot(ret.smrstr.m.plot)
```


### Standard Errors

```{r}
clstmodel.fitted.se <- apply(clstmodel.fitted, 2, sd)
clstmodel.fitted.se <- clstmodel.fitted.se/nrow(clstmodel.fitted)

```

```{r, results='asis'}

clstmodel.fitted.sedf <- data.frame(PrevSE = clstmodel.fitted.se)
clstmodel.fitted.sedf %>% 
  dplyr::mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
                options = list(
                  searching = T,
                  pageLength = 10,
                  dom = 'Bfrtip', 
                  buttons = c('csv')))
```


```{r}
clstmodel.fitted.se.raster <- 
  raster::rasterFromXYZ(cbind(clstmodel.coords[, "longnum"],
                              clstmodel.coords[, "latnum"],
                              clstmodel.fitted.se),
                        crs="+proj=longlat +datum=WGS84 +no_defs")


clstmodel.rstr.smooth <- raster::focal(clstmodel.fitted.se.raster, w=matrix(1,
                                                                                   nrow=5,
                                                                                   ncol=5), mean)
ret.smrstr.m  <-  raster::rasterToPoints(clstmodel.rstr.smooth)
ret.smrstr.m.df <-  data.frame(lon = clstmodel.rstr.smooth[,1], 
                               lat = clstmodel.rstr.smooth[,2], 
                               prev = clstmodel.rstr.smooth[,3])

ret.smrstr.m.plot <- ggplot() + 
  geom_raster(data = ret.smrstr.m.df, aes(lon, lat, fill = prev), alpha = 0.7) +
  scale_fill_gradient2("Standard Error", low = "#0000FF", mid = "#FFEC00", high = "#FF0000") +
  coord_sf(datum=NA)   # to get rid of gridlines



jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_postSE.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(ret.smrstr.m.plot)
graphics.off()

```

```{r, results='asis'}
plot(ret.smrstr.m.plot)
```








