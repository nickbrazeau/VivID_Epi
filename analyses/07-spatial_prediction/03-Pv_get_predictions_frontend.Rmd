---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Bayesian Hierarchial Spatial Model Predictions 

```{r, include=FALSE}
knitr::opts_chunk$set(echo = T, warning = F, message = F, eval = T, results = 'hide',
                      fig.align = 'center')
knitr::opts_knit$set(root.dir = here::here())
```

```{r}
library(tidyverse)
library(CARBayes)
library(PrevMap)
library(ggspatial)
set.seed(48)

load("~/Documents/GitHub/VivID_Epi/data/map_bases/vivid_maps_bases.rda")
drccites <- readxl::read_excel("~/Documents/GitHub/VivID_Epi/data/map_bases/DRC_city_coordinates.xlsx") %>% 
  dplyr::mutate(latnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,1] ),
                longnum = as.numeric( stringr::str_split_fixed(coordinates, ",", n=2)[,2] ) 
                )

```
  

## Spatial Predictions
Fitted values are taken from the Hierarchial Bayesian Spatial Models that were previously fit and determined to be the best model choice by model fit (Deviance Information Criteria).

### Province Models
```{r}
# import data
DRCprov <- readRDS("~/Documents/GitHub/VivID_Epi/data/map_bases/vivid_DRCprov.rds")
provmodel <- readRDS("~/Documents/GitHub/VivID_Epi/analyses/07-spatial_prediction/prov_map_final_long_chain/Province_Bayes_Hierarchial_Model_longchain.rds")
provmodel <- provmodel[provmodel$name == "CAR_covar", ] # best model

```

#### Fitted Values (Posterior Means)
```{r}
provs <- provmodel$data[[1]]$adm1name
provmodel.samples.fittedvalues <- provmodel$MCMC[[1]]$samples$fitted
provmodel.posteriormeans <- apply(provmodel.samples.fittedvalues, 2, mean)
```

```{r, results='asis'}
provmodel.posteriormeans <- cbind.data.frame(adm1name = provs, posteriormeanscounts = provmodel.posteriormeans) 
rownames(provmodel.posteriormeans) <- NULL

provmodel.posteriormeans %>% 
  dplyr::mutate_if(., is.numeric, round, 4) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv')))
```


```{r, results='asis'}
provmodel.posteriormeans <- cbind.data.frame(adm1name = provs, posteriormeansprev = provmodel.posteriormeans$posteriormeanscounts) 
provmodel.posteriormeans$posteriormeansprev <- provmodel.posteriormeans$posteriormeansprev/provmodel$data[[1]]$n
rownames(provmodel.posteriormeans) <- NULL

provmodel.posteriormeans %>% 
  dplyr::mutate_if(is.numeric, round, 4) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv')))
```


```{r}

#........................
# Bring it home
#........................
provmodelplotObjdf <- dplyr::left_join(DRCprov, provmodel.posteriormeans) 

provmodelplotObj <- ggplot() + 
  geom_sf(data = provmodelplotObjdf, aes(fill = posteriormeansprev), color = "#737373") +
      scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu") +
  coord_sf(datum=NA) +  # to get rid of gridlines
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum)) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.5, fontface = "bold") +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))

jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ProvMap_postMeans.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(provmodelplotObj)
graphics.off()

```

```{r, results='asis'}
plot(provmodelplotObj)
```

#### Standard Errors
```{r}
provmodel.sd <- apply(provmodel.samples.fittedvalues, 2, sd)
provmodel.se <- provmodel.sd/sqrt(nrow(provmodel.samples.fittedvalues))

```

```{r, results='asis'}
provmodel.posteriorse <- cbind.data.frame(adm1name = provs, posteriorses = provmodel.se) 
rownames(provmodel.posteriorse) <- NULL

provmodel.posteriorse %>% 
  dplyr::mutate_if(is.numeric, round, 4) %>% 
  DT::datatable(., extensions='Buttons',
                options = list(
                  searching = T,
                  pageLength = 10,
                  dom = 'Bfrtip', 
                  buttons = c('csv')))
```

```{r}
provmodel.posteriorseplotdf <- dplyr::left_join(DRCprov, provmodel.posteriorse) 


provmodel.posteriorselotObj <- ggplot() +
  geom_sf(data = provmodel.posteriorseplotdf, 
          aes(fill = posteriorses), color = "#737373") +
       scale_fill_distiller("Standard Error", type = "div", palette = "RdYlBu") +
  coord_sf(datum=NA) +
  prettybasemap_nodrc +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))

jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ProvMap_postSEs.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(provmodel.posteriorselotObj)
graphics.off()

```
```{r, results='asis'}
plot(provmodel.posteriorselotObj)
```


### Cluster Models 

#### Fitted Values (Posterior Means)

```{r}
# A "pred.PrevMap" object list with the following components: logit; prevalence; odds; probit;exceedance.prob, corresponding to a matrix of the exceedance probabilities where each column corresponds to a specified value in thresholds; samples, corresponding to a matrix of the posterior samples at each prediction locations for the linear predictor; grid.pred prediction locations. Each of the three components logit, prevalence, odds and probit is also a list with the following components:
source("~/Documents/GitHub/VivID_Epi/R/00-functions_basic.R")
# read rds
clstmodel <- readRDS("~/Documents/GitHub/VivID_Epi/analyses/07-spatial_prediction/_rslurm_Prevmap_predictions_large/results_1.RDS")
clstmodel.fitted <- expit(clstmodel[[1]]$samples)
clstmodel.coords <- clstmodel[[1]]$grid.pred
clstmodel.fitted.postmeans <- apply(clstmodel.fitted, 2, mean)
clstmodel.coords.means <- cbind.data.frame(clstmodel.coords, 
                                           fitted.postmean = clstmodel.fitted.postmeans)


#..............................................................
# Make Raster from PrevMap 
#..............................................................
clstmodel.fitted.postmeans.raster <- 
  raster::rasterFromXYZ(cbind(clstmodel.coords.means[, "longnum"],
                              clstmodel.coords.means[, "latnum"],
                              clstmodel.coords.means[, "fitted.postmean"]),
                        crs="+proj=longlat +datum=WGS84 +no_defs")
  

```

```{r, results='asis'}

clstmodel.fitted.postmeansdf <- data.frame(PrevPred = clstmodel.fitted.postmeans)
clstmodel.fitted.postmeansdf %>% 
  dplyr::mutate_if(is.numeric, round, 4) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv')))
```

```{r}

ret.smrstr.m.plot <- ggplot() + 
 ggspatial::layer_spatial(data = clstmodel.fitted.postmeans.raster, aes(fill = stat(band1))) +
  scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu") +
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum), alpha = 0.5) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.5, fontface = "bold", alpha = 0.5) +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_postMeans_raw.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(ret.smrstr.m.plot)
graphics.off()

```

```{r, results='asis'}
plot(ret.smrstr.m.plot)
```

##### Fitted Values Interpolate
```{r}
#..............................................................
# Get raster object at 0.05 x 0.05 resolution 
# and then set up raster and masking
#..............................................................
# boundaries for prediction
poly <- cbind(c(17,32,32,12,12), c(-14,-14,6,6,-14)) 
grid.pred.coords <- splancs::gridpts(poly, xs=0.05, ys=0.05)

# need this for bounding box
DRC <- sf::as_Spatial(osmdata::getbb("Democratic Republic of the Congo",
                                     featuretype = "country",
                                     format_out = 'sf_polygon'))
drcrstr <- raster::rasterFromXYZ(cbind(grid.pred.coords[,1],
                                       grid.pred.coords[,2],
                                       NA),
                                 crs="+proj=longlat +datum=WGS84 +no_defs")

#..............................................................
# interpolate
#..............................................................
colnames(clstmodel.coords.means) <- c("x", "y", "fitted.postmean")
idwmod <- gstat::gstat(id = "postmeans", formula = fitted.postmean ~ 1, 
                       locations = ~x + y, 
                       data = clstmodel.coords.means, 
                       set=list(idp = 2))

drcrstr.postmenas.idw <- raster::interpolate(drcrstr, idwmod)
drcrstr.postmenas.idw <- raster::mask(drcrstr.postmenas.idw, DRC)

#..............................................................
# plot
#..............................................................


ret.smrstr.m.plot <- ggplot() + 
 ggspatial::layer_spatial(data = drcrstr.postmenas.idw, aes(fill = stat(band1))) +
  scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu") +
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum), alpha = 0.5) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.5, fontface = "bold", alpha = 0.5) +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_postMeans_interpolate.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(ret.smrstr.m.plot)
graphics.off()


```



```{r, results='asis', fig.align = 'center', fig.width = 11, fig.height = 8}
#..............................................................
# figure for paper
#..............................................................
cowplot::plot_grid(provmodelplotObj, ret.smrstr.m.plot,
                   align = "h", nrow = 1)

jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/Prov_and_ClstMap_postMeans_interpolate.jpg",
     height = 8, width = 11, units = "in", res = 500)
cowplot::plot_grid(provmodelplotObj, ret.smrstr.m.plot,
                   align = "h", nrow = 1, labels = c("(A)", "(B)"))
graphics.off()


svglite::svglite(file = "~/Documents/GitHub/VivID_Epi/results/figures/Prov_and_ClstMap_postMeans_interpolate.svg",
     height = 8, width = 11)
cowplot::plot_grid(provmodelplotObj, ret.smrstr.m.plot,
                   align = "h", nrow = 1, labels = c("(A)", "(B)"))
graphics.off()


```


#### Standard Errors

```{r}
clstmodel.fitted.se <- apply(clstmodel.fitted, 2, sd)
clstmodel.fitted.se <- clstmodel.fitted.se/nrow(clstmodel.fitted)

```

```{r, results='asis'}

clstmodel.fitted.sedf <- data.frame(PrevSE = clstmodel.fitted.se)
clstmodel.fitted.sedf %>% 
  #dplyr::mutate_if(is.numeric, round, 4) %>% 
  DT::datatable(., extensions='Buttons',
                options = list(
                  searching = T,
                  pageLength = 10,
                  dom = 'Bfrtip', 
                  buttons = c('csv')))
```


```{r}
clstmodel.fitted.se.raster <- 
  raster::rasterFromXYZ(cbind(clstmodel.coords[, "longnum"],
                              clstmodel.coords[, "latnum"],
                              clstmodel.fitted.se),
                        crs="+proj=longlat +datum=WGS84 +no_defs")



ret.smrstr.m.plot <- ggplot() + 
  ggspatial::layer_spatial(data = clstmodel.fitted.se.raster, aes(fill = stat(band1)),
                           interpolate = TRUE) +
  scale_fill_distiller("Standard Error", type = "div", palette = "RdYlBu") +
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum), alpha = 0.5) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.5, fontface = "bold", alpha = 0.5) +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))



jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_postSE_raw.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(ret.smrstr.m.plot)
graphics.off()

```

```{r, results='asis'}
plot(ret.smrstr.m.plot)
```

##### SE Values Interpolate
```{r}

#..............................................................
# interpolate
#..............................................................
clstmodel.coords.se <- cbind.data.frame(clstmodel.coords,
                                        seFit = clstmodel.fitted.se)

colnames(clstmodel.coords.se) <- c("x", "y", "seFit")
idwmod <- gstat::gstat(id = "postmeans", formula = seFit ~ 1, 
                       locations = ~x + y, 
                       data = clstmodel.coords.se, 
                       set=list(idp = 2))

drcrstr.postSE.idw <- raster::interpolate(drcrstr, idwmod)
drcrstr.postmSE.idw <- raster::mask(drcrstr.postSE.idw, DRC)

#..............................................................
# plot
#..............................................................


ret.smrstr.m.plot <- ggplot() + 
 ggspatial::layer_spatial(data = drcrstr.postmSE.idw, aes(fill = stat(band1))) +
  scale_fill_distiller("Standard Error", type = "div", palette = "RdYlBu") +
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum), alpha = 0.5) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.5, fontface = "bold", alpha = 0.5) +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_SE_interpolate.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(ret.smrstr.m.plot)
graphics.off()


```




```{r, results='asis', fig.align = 'center', fig.width = 11, fig.height = 8}
#..............................................................
# figure for paper
#..............................................................
cowplot::plot_grid(provmodel.posteriorselotObj, ret.smrstr.m.plot,
                   align = "h", nrow = 1)

jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/Prov_and_ClstMap_postSE.jpg",
     height = 8, width = 11, units = "in", res = 500)
cowplot::plot_grid(provmodel.posteriorselotObj, ret.smrstr.m.plot,
                   align = "h", nrow = 1, labels = c("(A)", "(B)"))
graphics.off()


svglite::svglite(file = "~/Documents/GitHub/VivID_Epi/results/figures/Prov_and_ClstMap_postSE.svg",
     height = 8, width = 11)
cowplot::plot_grid(provmodel.posteriorselotObj, ret.smrstr.m.plot,
                   align = "h", nrow = 1, labels = c("(A)", "(B)"))
graphics.off()



```

### Cluster Model Covariates
```{r}
#..............................................................
# Read in Rasters that I used for covariates
#..............................................................
precipraster <- readRDS("~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_precip_study_period_effsurface.rds") 

# take mean here since we converted to binary
cropraster <- readRDS("~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_cropland_surface.rds")
cropraster <- raster::aggregate(cropraster, fact = 18, fun = mean)

# sum here under the assumption that night lights are additive (population density is additive)
nightligthraster <- raster::raster("~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_nightlights_surface.grd")
nightligthraster <- raster::aggregate(nightligthraster, fact = 12, fun = sum)

#..............................................................
# Set bounds for interpolation only again
#..............................................................
# precip
dt <- readRDS("~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_recode_completecases.rds")
precip <- dt %>% 
  dplyr::select("hv001", "precip_mean_cont_clst") %>% 
  dplyr::filter(!duplicated(.))
max.precip <- max(precip$precip_mean_cont_clst)
min.precip <- min(precip$precip_mean_cont_clst)
values(precipraster)[values(precipraster) >  max.precip] <- max.precip
values(precipraster)[values(precipraster) < min.precip] <- min.precip

# bring in cropland
crop <- readRDS("~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_cropland_propmeans.rds") 
max.crop <- max(crop$cropprop)
min.crop <- min(crop$cropprop)
values(cropraster)[values(cropraster) >  max.crop] <- max.crop
values(cropraster)[values(cropraster) < min.crop] <- min.crop


# bring in nightlights
nightlists <- readRDS("~/Documents/GitHub/VivID_Epi/data/derived_data/vividepi_night_clstmeans.rds") 
max.night <- max(nightlists$nightlightsmean)
min.night <- min(nightlists$nightlightsmean)
values(nightligthraster)[values(nightligthraster) >  max.night] <- max.night
values(nightligthraster)[values(nightligthraster) < min.night] <- min.night

```

##### Precip
```{r, results='asis', fig.width=11, fig.height=8}

precip.plot <- ggplot() + 
 ggspatial::layer_spatial(data = precipraster, aes(fill = stat(band1))) +
  scale_fill_viridis_c("Precipiation") +
  smpl_base_map +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


```


##### Crops
```{r, results='asis'}

crop.plot <- ggplot() + 
 ggspatial::layer_spatial(data = cropraster, aes(fill = stat(band1))) +
  scale_fill_viridis_c("Crop Proportion") +
  smpl_base_map +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


```


##### Night Lights
```{r, results='asis'}

night.plot <- ggplot() + 
 ggspatial::layer_spatial(data = nightligthraster, aes(fill = stat(band1))) +
  scale_fill_viridis_c("Night Lights") +
  smpl_base_map +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


```

```{r}
#..............................................................
# figure for paper
#..............................................................
cowplot::plot_grid(precip.plot, crop.plot, night.plot,
                   align = "h", nrow = 1)

jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/Clst_Covariates.jpg",
     height = 11, width = 8, units = "in", res = 800)
cowplot::plot_grid(precip.plot, crop.plot, night.plot,
                   align = "v", ncol = 1)
graphics.off()


svglite::svglite(file = "~/Documents/GitHub/VivID_Epi/results/figures/Clst_Covariates.svg",
     height = 11, width = 8)
cowplot::plot_grid(precip.plot, crop.plot, night.plot,
                   align = "v", ncol = 1, labels = c("(A)", "(B)", "(C)"))
graphics.off()




```



## Appendix 
### Same Scale as Pf
```{r}
clstmodel.fitted.postmeans.raster <- 
  raster::rasterFromXYZ(cbind(clstmodel.coords[, "longnum"],
                              clstmodel.coords[, "latnum"],
                              clstmodel.fitted.postmeans),
                        crs="+proj=longlat +datum=WGS84 +no_defs")
  


ret.smrstr.m.plot <- ggplot() + 
  ggspatial::layer_spatial(data = clstmodel.fitted.postmeans.raster, aes(fill = stat(band1))) +
  scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu", limits = c(0, 0.6)) +
  prettybasemap_nodrc +
  geom_point(data = drccites, aes(x = longnum, y=latnum)) + 
  geom_text(data = drccites, aes(label = city, x = longnum, y=latnum), 
            hjust = 0.5, vjust = 0.5, nudge_y = 0.5, fontface = "bold") +
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_postMeans_samescale_pf.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(ret.smrstr.m.plot)
graphics.off()

```

```{r, results='asis'}
plot(ret.smrstr.m.plot)
```


#### With Cluster Prev Points
```{r}
mp <- readRDS( "~/Documents/GitHub/VivID_Epi/data/derived_data/basic_cluster_mapping_data.rds")
pvclst <- mp[mp$plsmdmspec == "pv18s" & mp$maplvl == "hv001", ]
pvclst <- pvclst$data[[1]]

clst.points <- ggplot() + 
 ggspatial::layer_spatial(data = drcrstr.postmenas.idw, aes(fill = stat(band1))) +
  scale_fill_distiller("Prevalence", type = "div", palette = "RdYlBu") +
  prettybasemap_nodrc +
  geom_point(data = pvclst, aes(x=longnum, y=latnum, color = plsmdprev), 
             alpha = 0.5, shape = 16) + 
  scale_color_viridis_c() + 
  theme(legend.position = "right",
        legend.title = element_text(size = 13, face = "bold", angle = 0, vjust = 0.5, hjust = 0.5),
        legend.text = element_text(size = 12, face = "bold", angle = 0))


jpeg(file = "~/Documents/GitHub/VivID_Epi/results/figures/ClstMap_postMeans_interpolate_clst.jpg",
     height = 11, width = 8, units = "in", res = 500)
plot(clst.points)
graphics.off()


```
```{r, results='asis'}
plot(clst.points)
```


