---
title: "EDA-1"
author: "Nicholas Brazeau Brazeau"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    highlight: textmate
    theme: lumen
    toc: yes
    toc_float: yes
    toc_depth: 2
editor_options: 
  chunk_output_type: console
---

<style>

table, td, th {
  border: none;
  padding-left: 1em;
  padding-right: 1em;
  min-width: 50%;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1em;
  margin-bottom: 1em;
}

</style>

```{r setup, echo=T, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

#Data Wrangling
source("~/Documents/GitHub/VivID_Epi/analyses/00-functions.R")
library(tidyverse)
devtools::install_github("OJWatson/rdhs", ref="master")
library(rdhs)
devtools::install_github("kaz-yos/tableone")
library(tableone)
# regression
library(nlme) # Linear Mixed-Effects Models
library(lme4)

#......................
# Import Data
#......................
load("~/Documents/GitHub/VivID_Epi/data/vividepi_raw.rda")
dt <- merge_pr_plsmdm_gemtdt(pr = arpr, plsmdm = panplasmpcrres, ge = ge)



```


# Overview
**Outcome (binary)**: _P. vivax_ infection (i.e. parasitemia detectable by RT-PCR)
**Space is also an obvious risk factor but we will consider that separately. In addition, as shown in Lo _et al._ 2019, temperature/rainfall patterns and altitude are also potential risk factors. Will look at that with DHS but should also consider other data sources**.

**Exposure of Interests**
The variables that I care about as potential risk factors are: 

  2. pfldh (result of Pfalciparum RT-PCR scoring system) coinfection
  2. po18s
  7. HIV Status (HIV03)
  7. Type of Residence i.e. Rural or Urban (HV025)
  7. Cluster altitude (HV040)
  7. Drinking Water (categorical: HV201)
  7. Non-Drinking water (categorical: HV202)
  7. Main floor material (categorical: HV213)
  7. Main wall material (categorical: HV214)
  7. Main roof material (categorical: HV215)
  7. Shares toilet with other household (HV225)
  8. Wealth Index (HV270)
  9. Biological Sex (HV104)
  9. Age (HV105)
  10. Highest year of education completed (continous: HV107) 
  10. Hemoglobin Level adjust for altitude and smoking (HA56 & HB56)
  10. Currently pregnant? (HA54)
  10. Person slept under an LLIN net (HML20)/Net by Insecticide 



## DHS Overview

### Considerations for Bednets
The way the DHS was set up based on the [Malaria Indicator Survey Questionnaire -- 	06 MIS Interviewers Manual ](http://malariasurveys.org/toolkit.cfm) the way questions are answered is as follows (loosely):
  1. Person from house bring the interviewer all the nets 
  2. Then they ask when net obtained, TYPE and BRAND of bednet, source of net
  2. Then they ask if the net was ever treated since they have owned 
  3. NEXT they ask who slept under the bednet in two part. Did you sleep under an ever treated net. And did person sleep under an LLIN net -- this is what is used to link the data to the survey  
   
Here I will create my main exposure, type of bednet.
[WHO Recommended LLIN](http://who.int/whopes/Long-lasting_insecticidal_nets_April_2016.pdf)
paste("Note WHO has information except for NetProtect.")
[Permanet 2.0](http://www.vestergaard.com/permanet-2-0)
[Olyset](http://sumivector.com/mosquito-nets/olyset-net)
[Duranet](http://duranetllin.com/)
[Interceptor](http://duranetllin.com/)
[Yorkool](http://www.treated-bednet.eu/yorkool_ln.html)
[LifeNet](https://www.cropscience.bayer.us/news/press-releases/2012/lifenet-mosquito-nets-now-available)
[MAGNet](http://www.mosquitomagnet.com/store/mosquito-magnet-accessories/nets)
[Serena](http://hzsn.en.alibaba.com/product/1664650287-200124492/Serena_long_lasting_insecticide_treated_nets_LLINs_Mosquito_Net_coated_with_WHOPES_approved_Insecticide_Treated_Mosquito_Net.html)
[Netprotect](http://www.insectcontrol.net/permanent_partnership/index.php) 
As a result, in the individual recode there should be no net data for a person if they did not sleep under the net the night before ("who slept under the net last night"). Need to confirm this.  


```{r recode}

#------------------------------------------
# RECODE
#------------------------------------------


# init
dt$NetInsecticide <- NA

#------------------------------------------
# Bed Net Insecticide Type
#------------------------------------------
# Exclusion 1: Are all ever-treated nets even ITN nets?
# here making exclusion variable for observations that were not ITN (HML10=0) but person said that they slept under an ever-treated net. 
dt$excl_netnotITN <- ifelse((dt$hml10 == 0 & dt$hml19 == 1), 1, 0)

# Exclusion 2: Are nets LLIN
dt$excl_netnotLLIN <- ifelse((dt$hml19 == 1 & dt$hml20 == 0), 1, 0)

# Exclusion 3: Brands of LLIN Unknown or Other (so can't get insecticide)
dt$excl_brandnotdeterm <- ifelse((dt$hml7 == 96 | dt$hml7 == 98), 1, 0)


### NOW CODE UP INSECTICIDE BY BRAND
dt$NetInsecticide[dt$hml7 == 11 & dt$excl_netnotLLIN == 0] <- "deltamethrin"
dt$NetInsecticide[dt$hml7 == 12 & dt$excl_netnotLLIN == 0] <- "permethrin"
dt$NetInsecticide[dt$hml7 == 13 & dt$excl_netnotLLIN == 0] <- "alphacypermethrin"
dt$NetInsecticide[dt$hml7 == 14 & dt$excl_netnotLLIN == 0] <- "alphacypermethrin"
dt$NetInsecticide[dt$hml7 == 15 & dt$excl_netnotLLIN == 0] <- "deltamethrin"
dt$NetInsecticide[dt$hml7 == 16 & dt$excl_netnotLLIN == 0] <- "deltamethrin"
dt$NetInsecticide[dt$hml7 == 17 & dt$excl_netnotLLIN == 0] <- "alphacypermethrin"
dt$NetInsecticide[dt$hml7 == 18 & dt$excl_netnotLLIN == 0] <- "deltamethrin"
dt$NetInsecticide[dt$hml7 == 19 & dt$excl_netnotLLIN == 0] <- "deltamethrin"

## FOR NO NET this is simply going to be those who did not use ANY form of protection
dt$NetInsecticide[dt$hml7 == 0] <- "nonet" #some people reported the brand of their nets that they owned even though they didn't use 


#------------------------------------------
# Anemia Recode
#------------------------------------------
### Anemic Covariate Recode
# init new var
dt$adjhb <- NA
dt$adjhb[!is.na(dt$ha56)] <- dt$ha56[!is.na(dt$ha56)]
dt$adjhb[!is.na(dt$hb56)] <- dt$hb56[!is.na(dt$hb56)]
dt$adjhb[dt$adjhb==997] <- NA
dt$adjhb[dt$adjhb==999] <- NA

#------------------------------------------
# sex
#------------------------------------------
dt$hv104 <- haven::as_factor(dt$hv104)

#------------------------------------------
# Urban
#------------------------------------------
dt$hv025 <- haven::as_factor(dt$hv025)

#------------------------------------------
# Wealth
#------------------------------------------
dt$hv270 <- haven::as_factor(dt$hv270)

#------------------------------------------
# Main Floor, Wall, Roof Material
#------------------------------------------
dt$hv213 <- haven::as_factor(dt$hv213) # floor
dt$hv214 <- haven::as_factor(dt$hv214) # wall
dt$hv215 <- haven::as_factor(dt$hv215) # roof


#------------------------------------------
# age
#------------------------------------------
dt$hv105[dt$hv105 %in% c("97", "98", "99")] <- NA # no 97s in DRC
dt$hv105 <- haven::zap_labels(dt$hv105)

#------------------------------------------
# pregnant
#------------------------------------------
dt$ha54 <- haven::as_factor(dt$ha54)

#------------------------------------------
# education
#------------------------------------------
dt$hv106 <- haven::as_factor(dt$hv106)

#------------------------------------------
# cluster altitude
#------------------------------------------
dt$hv040[dt$hv040  == 9999] <- NA

#------------------------------------------
# toilet
#------------------------------------------
dt$hv205 <- haven::as_factor(dt$hv205)
dt$hv225 <- haven::as_factor(dt$hv225)


#------------------------------------------
# children under 5 number
#------------------------------------------
# summary(dt$hv014) # looks clean

#------------------------------------------
# malaria
#------------------------------------------
# dt$pfldh <- factor(dt$pfldh, levels = c(0,1), labels = c("neg", "pos"))
# dt$pv18s <- factor(dt$pv18s, levels = c(0,1), labels = c("neg", "pos"))
# dt$po18s <- factor(dt$po18s, levels = c(0,1), labels = c("neg", "pos"))

#------------------------------------------
# weights
#------------------------------------------
dt$hv005 <- dt$hv005/1e5

```

## Spatial Analysis
### Maps
Prevalence is aggregated at the province level (right). Prevalence is aggregated at the cluster level (left). Clusters are scaled by `n`. 
```{r map, fig.width=11, fig.height=8}
prev_summarizer <- function(data, maplvl, plsmdmspec, sfobj){
  
  
  # catch error
  # if( !( any(colnames(x) %in% c("hv001")) & any(colnames(x) %in% c("hv005")) ) ){
  #   stop("Must include cluster and cluster weight. need to check if you are using pr or hiv sample weights")
  # }
  # rlang
  maplvl <- enquo(maplvl)
  plsmdmspec <- enquo(plsmdmspec)
  
  # clusters are weighted (each individual has same weight in cluster)
  ret <- data %>% 
    srvyr::as_survey_design(ids = hv001, weights = hv005) %>% 
    dplyr::group_by(!!maplvl) %>% 
    dplyr::summarise(plsmdn = srvyr::survey_total(hv001), 
                     plsmd = srvyr::survey_mean(!!plsmdmspec, na.rm = T, vartype = c("se", "ci"), level = 0.95)) %>% 
    dplyr::left_join(., sfobj) # attach spatial data, let R figure out the common var
  # return
  return(ret)
}

pv18sprov <- prev_summarizer(data = dt, maplvl = adm1name, plsmdmspec = pv18s, sfobj = DRCprov)  %>% 
  dplyr::mutate(plsmdmspec = "pv18s", maplvl = "adm1name")

pv18sclust <- prev_summarizer(data = dt, maplvl = hv001, plsmdmspec = pv18s, sfobj = ge) %>% 
  dplyr::mutate(plsmdmspec = "pv18s", maplvl = "hv001")



# this awful hack becuase of this issue https://github.com/tidyverse/dplyr/issues/3483
# we are going down the rabbit hole just to try and make this stupid survey and purr package work. fine for now but return
mp <- dplyr::bind_rows(pv18sprov,  pv18sclust) %>% 
  dplyr::group_by(plsmdmspec, maplvl) %>% 
  tidyr::nest()

mp$data <- sapply(list(pv18sprov, pv18sclust), function(x) return(x))


#......................
# Plot Maps
#......................
mapplotter <- function(data, maplvl, plsmdmspec){
  
  
  ret <- ggplot() + 
    geom_sf(data = DRCprov) +
    ggtitle(paste(plsmdmspec)) +
    theme(plot.title = element_text(famil = "Arial", face = "bold", hjust = 0.5, size = 13), 
          legend.position = "bottom",
          legend.title = element_text(famil = "Arial", face = "bold", vjust = 0.85, size = 12),
          legend.text = element_text(famil = "Arial", hjust = 0.5, vjust = 0.5, angle = 90, size = 10),
          axis.text = element_blank(),
          axis.line = element_blank(),
          panel.background = element_rect(fill = "transparent"),
          plot.background = element_rect(fill = "transparent"),
          panel.grid = element_blank(),
          panel.border = element_blank())
  
  if(maplvl == "adm1name"){
    
    ret <- ret + geom_sf(data = data, aes(fill = plsmd)) +
      scale_fill_gradient2("Prevalence", low = "#0000FF", mid = "#FFEC00", high = "#FF0000") + 
      coord_sf(datum=NA)  # to get rid of gridlines
    
  } else if(maplvl == "hv001"){
    
    ret <- ret + geom_sf(data = data, aes(fill = plsmd, colour = plsmd, size = plsmdn), alpha = 0.8) +
      scale_color_gradient2("Prevalence", low = "#0000FF", mid = "#FFEC00", high = "#FF0000") + 
      scale_size(guide = 'none') +  scale_fill_continuous(guide = 'none') +
      coord_sf(datum=NA)  # to get rid of gridlines
    
  } else {
    stop("maplvl is not in the options for this function")
  }
  
  
  return(ret)
  
}

prevmaps <- pmap(mp, mapplotter)

gridExtra::grid.arrange(prevmaps[[1]], 
                        prevmaps[[2]],
                        nrow=1, top=grid::textGrob("Prevalence by Pvivax in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold"))) 


```

### Summary Stats
### Province
Weighted cluster prevalence estimates 
```{r}

dt %>% 
    srvyr::as_survey_design(ids = hv001, weights = hv005) %>% 
    dplyr::group_by(hv001) %>% 
    dplyr::summarise(plsmdn = srvyr::survey_total(hv001), 
                     plsmd = srvyr::survey_mean(pv18s, na.rm = T, vartype = c("se", "ci"), level = 0.95)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 20,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 



```

### Cluster
Weighted cluster prevalence estimates 
```{r}
dt %>% 
    srvyr::as_survey_design(ids = hv001, weights = hv005) %>% 
    dplyr::group_by(adm1name) %>% 
    dplyr::summarise(plsmdn = srvyr::survey_total(hv001), 
                     plsmd = srvyr::survey_mean(pv18s, na.rm = T, vartype = c("se", "ci"), level = 0.95)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 20,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 

```

### Household
Weighted cluster prevalence estimates 
```{r}
dt %>% 
    srvyr::as_survey_design(ids = hv001, weights = hv005) %>% 
    dplyr::group_by(hv002) %>% 
    dplyr::summarise(plsmdn = srvyr::survey_total(hv001), 
                     plsmd = srvyr::survey_mean(pv18s, na.rm = T, vartype = c("se", "ci"), level = 0.95)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 20,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 
  

```



# Non-parametric, Bivariate Analysis
For potential risk factors, these are the nx2 tables for categorical variables and mean/t-test for continuous.
```{r}

keep <- c("pv18s", "pfldh", "po18s", "NetInsecticide", "adjhb", "hv104", "hv105", "hv025", 
          "hv270", "hv213", "hv214", "hv215", "ha54", "hv106", "hv014", 
          "hv205", "hv225", "adm1name")
dtsub <- dt[, keep]
colnames(dtsub) <- c("pv18s", "pfldh", "po18s", "NetInsecticide", "adjhb", "sex", "age", "urbanrural", 
                     "Wealthindex", "floormaterial", "wallmaterial", "roofmaterial", "pregnant", "education", "NumChildU5",
                     "toilettype", "sharestoilet", "adm1name")

vars <- c("pfldh", "po18s", "NetInsecticide", "adjhb", "sex", "age", "urbanrural", 
                     "Wealthindex", "floormaterial", "wallmaterial", "roofmaterial", "pregnant", "education", "NumChildU5",
                     "toilettype", "sharestoilet")



tableone::kableone(tableone::CreateTableOne(data=dtsub, strata = "pv18s", vars = vars))

#  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "center")

```



# Parametric, Bivariate Analysis
Odds Ratios with Pv as the outcome.
```{r}
model_parameters <- data.frame(outcome = rep("pv18s", length(vars)), covar = vars, stringsAsFactors=FALSE)

fitglm <- fit_model <- function(outcome, covar){
  
   eq <- as.formula(paste0(outcome, "~", covar))
   ret <- glm(eq,
               data = dtsub,
               family=binomial(link="logit"))
  
   return(ret)
   
}

model_parameters$glmlogit <- purrr::pmap(model_parameters, .f=fitglm)
model_parameters$glmlogit_tidy <- purrr::map(model_parameters$glmlogit, .f=function(x) broom::tidy(x, exponentiate=TRUE, conf.int=TRUE))
```


### Model Comparison
```{r, results='asis'}

stargazer::stargazer(model_parameters$glmlogit, title = "Logistic Bivariate Risk Factor Models",
          no.space=F,
          ci=TRUE, ci.level=0.95, 
          single.row=F,
          align=T, 
          type = "html")

```

### Estimates

```{r}
est <- do.call("rbind", model_parameters$glmlogit_tidy)

est %>% 
  dplyr::filter(term != "(Intercept)") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  dplyr::rename(PvOR = estimate) %>% 
  knitr::kable(., "html") %>%  # note must tell kableExtra html or latex
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "center")
  


```


# Parametric, Bivariate Analysis, Province Level Random Effect
Odds Ratios with Pv as the outcome. Note, these aren't exponentiated estimates. So they are logit-odds (long story. Will fix eventually).
```{r}
dtsub$adm1name <- as.numeric(factor(dtsub$adm1name))
fitglm_prov <- fit_model <- function(outcome, covar, data){
  
   eq <- as.formula(paste0(outcome, "~", covar, "+ (1|adm1name)"))
   ret <- glm(eq,
               data = dtsub,
               family=binomial(link="logit"))
  
   return(ret)
   
}

model_parameters$glmlogit_mlm <- purrr::pmap(model_parameters[,1:2], .f=fitglm_prov)
model_parameters$glmlogit_mlm_tidy <- purrr::map(model_parameters$glmlogit_mlm, .f=function(x) broom::tidy(x, exponentiate=TRUE, conf.int=TRUE))
```


### Model Comparisons
```{r, results='asis'}
stargazer::stargazer(model_parameters$glmlogit, title = "Logistic Bivariate Risk Factor Models Multilevel w/ random effects",
          no.space=F,
          ci=TRUE, ci.level=0.95, 
          single.row=F,
          align=T, 
          type = "html")

```


### Estimates
```{r}

est2 <- do.call("rbind", model_parameters$glmlogit_mlm_tidy)

est2 %>% 
  dplyr::filter(term != "(Intercept)") %>% 
  dplyr::bind_rows(.) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  dplyr::rename(PvOR = estimate) %>% 
  knitr::kable(., "html") %>%  # note must tell kableExtra html or latex
  kableExtra::kable_styling(bootstrap_options = "striped", full_width = F, position = "center")







```


