---
title: "EDA -- Variable Dependence on Space"
author: "Nicholas F. Brazeau"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  html_document:
    highlight: textmate
    theme: lumen
    toc: yes
    toc_float: yes
    toc_depth: 2
    code_folding: hide
editor_options: 
  
  chunk_output_type: console
---

<style>

table, td, th {
  border: none;
  padding-left: 1em;
  padding-right: 1em;
  min-width: 50%;
  margin-left: auto;
  margin-right: auto;
  margin-top: 1em;
  margin-bottom: 1em;
}

</style>

```{r setup, echo=T, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F)

#Data Wrangling
source("~/Documents/GitHub/VivID_Epi/analyses/00-functions.R")
library(tidyverse)
library(sf)
devtools::install_github("kaz-yos/tableone")
library(tableone)

#......................
# Import Data
#......................
load("~/Documents/GitHub/VivID_Epi/data/vividepi_recode.rda")
load("~/Documents/GitHub/VivID_Epi/reports/report_obj/04-basic_mapping_objs.rda")

```


# Overview
**Outcome (binary)**: _P. vivax_ infection (i.e. parasitemia detectable by RT-PCR)
**Space, climate, and time are obvious risk factors that warranted consideration.** Recently, Lo _et al._ 2019 demonstrated that temperature/rainfall patterns and altitude are  potential risk factors for _Pv_ infection. 




# Spatial Analysis

## Prevalence Maps

### Unstandardized Point Estimate Prevalence Maps by Species, Weighted {.tabset .tabset-fade .tabset-pill}
Each tab is a prevalence map for a malaria species

#### _P. vivax_
```{r, results='hide', fig.keep='all'}
gridExtra::grid.arrange(prevmaps[[2]], 
                        prevmaps[[5]],
                        ncol=2, top=grid::textGrob("Vivax Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))





```

#### _P. falciparum_
```{r, results='hide', fig.keep='all'}
gridExtra::grid.arrange(prevmaps[[1]], 
                        prevmaps[[4]],
                        ncol=2, top=grid::textGrob("Falciparum Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```

#### _P. ovale_
```{r, results='hide', fig.keep='all'}
gridExtra::grid.arrange(prevmaps[[3]], 
                        prevmaps[[6]],
                        ncol=2, top=grid::textGrob("Ovale Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```

#### All
```{r, results='hide', fig.keep='all'}
gridExtra::grid.arrange(prevmaps[[1]], 
                        prevmaps[[2]],
                        prevmaps[[3]],
                        prevmaps[[4]],
                        prevmaps[[5]],
                        prevmaps[[6]],
                        nrow=2, top=grid::textGrob("Prevalence by Species in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```
###


### Standardized Point Estimate Prevalence Maps by Species, Weighted {.tabset .tabset-fade .tabset-pill}
Each tab is a prevalence map for a malaria species

#### _P. vivax_
```{r, results='hide', fig.keep='all'}
gridExtra::grid.arrange(prevhist[[2]], 
                        zscoreprevmaps[[2]],
                        ncol=2, top=grid::textGrob("Vivax Standardized Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```

#### _P. falciparum_
```{r, results='hide', fig.keep='all'}
gridExtra::grid.arrange(prevhist[[1]], 
                        zscoreprevmaps[[1]],
                        ncol=2, top=grid::textGrob("Falciparum Standardized Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```

#### _P. ovale_
```{r, results='hide', fig.keep='all'}
gridExtra::grid.arrange(prevhist[[3]], 
                        zscoreprevmaps[[3]],
                        ncol=2, top=grid::textGrob("Ovale Standardized Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```

#### All
```{r, results='hide', fig.keep='all'}

 gridExtra::grid.arrange(prevhist[[1]],
                        prevhist[[2]],
                        prevhist[[3]],
                        zscoreprevmaps[[1]], 
                        zscoreprevmaps[[2]],
                        zscoreprevmaps[[3]],
                        nrow=2, 
                        top=grid::textGrob("Histograms and Standardized Prevalence by Species in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold"))) 

```
###

### Terrain Maps with Point Estimate Prevalence by Species (Weighted) {.tabset .tabset-fade .tabset-pill}
Each tab is a prevalence map for a malaria species

#### _P. vivax_
```{r, results='hide', fig.keep='all', fig.width = 11, fig.width=8}

gridExtra::grid.arrange(terrmaps[[2]], 
                        ncol=2, top=grid::textGrob("Vivax Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```

#### _P. falciparum_
```{r, results='hide', fig.keep='all', fig.width = 11, fig.width=8}
gridExtra::grid.arrange(terrmaps[[1]], 
                        ncol=2, top=grid::textGrob("Falciparum Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```

#### _P. ovale_
```{r, results='hide', fig.keep='all', fig.width = 11, fig.width=8}
gridExtra::grid.arrange(terrmaps[[3]], 
                        ncol=2, top=grid::textGrob("Ovale Prevalence in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```
#### All
```{r, results='hide', fig.keep='all', fig.width = 11, fig.width=8}
gridExtra::grid.arrange(terrmaps[[1]], 
                        terrmaps[[2]],
                        terrmaps[[3]],
                        ncol=3, top=grid::textGrob("Prevalence by Species in CD2013 DHS", gp=grid::gpar(fontsize=15, fontfamily = "Arial", fontface = "bold")))

```
###


### _P. vivax_ Summary Stats with Weights {.tabset .tabset-fade .tabset-pill}
#### Province
Weighted province prevalence estimates 
```{r}

dt %>% 
    dplyr::mutate(count = 1) %>% 
    srvyr::as_survey_design(ids = hv001, weights = hiv05_cont) %>% 
    dplyr::group_by(adm1name) %>% 
    dplyr::summarise(plsmdn = srvyr::survey_total(count, vartype = c("se", "ci")), 
                     plsmd = srvyr::survey_mean(pv18s, na.rm = T, vartype = c("se", "ci"), level = 0.95)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 



```

#### Cluster
Weighted cluster prevalence estimates 
```{r}
dt %>% 
    dplyr::mutate(count = 1) %>% 
    srvyr::as_survey_design(ids = hv001, weights = hiv05_cont) %>% 
    dplyr::group_by(hv001) %>% 
    dplyr::summarise(plsmdn = srvyr::survey_total(count, vartype = c("se", "ci")), 
                     plsmd = srvyr::survey_mean(pv18s, na.rm = T, vartype = c("se", "ci"), level = 0.95)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 

```

#### Household
Weighted household prevalence estimates 
```{r}
dt %>% 
    dplyr::mutate(count = 1) %>% 
    srvyr::as_survey_design(ids = hv001, weights = hiv05_cont) %>% 
    dplyr::group_by(hhid_fct) %>% 
    dplyr::summarise(plsmdn = srvyr::survey_total(count, vartype = c("se", "ci")), 
                     plsmd = srvyr::survey_mean(pv18s, na.rm = T, vartype = c("se", "ci"), level = 0.95)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 
  

```
### 





### _P. vivax_ Summary Stats Unweights {.tabset .tabset-fade .tabset-pill}
#### Province
Unweighted province prevalence estimates 
```{r}

dt %>% 
    dplyr::group_by(adm1name) %>% 
    dplyr::summarise(plsmdn = n(), 
                     plsmd = mean(pv18s)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 



```

#### Cluster
Unweighted cluster prevalence estimates 
```{r}
dt %>% 
    dplyr::group_by(hv001) %>% 
    dplyr::summarise(plsmdn = n(), 
                     plsmd = mean(pv18s)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 

```

#### Household
Unweighted household prevalence estimates 
```{r}
dt %>% 
    dplyr::group_by(hhid_fct) %>% 
    dplyr::summarise(plsmdn = n(), 
                     plsmd = mean(pv18s)) %>% 
  mutate_if(is.numeric, round, 2) %>% 
  DT::datatable(., extensions='Buttons',
               options = list(
              searching = T,
              pageLength = 10,
              dom = 'Bfrtip', 
              buttons = c('csv'))) 
  

```

#### Household Dist
Unweighted household prevalence estimates that are plotted where `Pv18s != 0` and `household membership > 1`
```{r}
dt %>% 
    dplyr::group_by(hhid_fct) %>% 
    dplyr::summarise(plsmdn = n(), 
                     plsmd = mean(pv18s)) %>% 
    dplyr::filter(plsmd != 0) %>%
  ggplot() +
  geom_violin(aes(x=factor(plsmdn), y=plsmd, fill = factor(plsmdn))) +
  vivid_theme +
  guides(fill=FALSE)

```
### 


## _Plasmodium_ Species Prevalence Correlation, Weighted
### By Province
#### _Pf_ versus _Pv_ Prevalence  {.tabset .tabset-fade .tabset-pill}
Points are scaled by size of province (and color of province). Loess curve in red. 
```{r}
pfprov <- mp$data[[1]]
colnames(pfprov)[4] <- "Pf_prev"

pvprov <- mp$data[[2]]
colnames(pvprov)[4] <- "Pv_prev"
  

plotObj <- dplyr::bind_cols(pfprov, pvprov) %>% 
  ggplot(aes(x=Pf_prev, y=Pv_prev, size = n)) +
  geom_point(aes(colour = adm1name)) +
  geom_smooth(method="loess", se=F, colour = "red") +
      ggtitle("Pfalciparum versus Pvivax Province Prevalence") + ylab("Pv Prevalence") + xlab("Pf Prevalence") + 
  vivid_theme

plotly::ggplotly(plotObj)

```

#### _Pv_ versus _Po_ Prevalence 
Points are scaled by size of province (and color of province). Loess curve in red. 
```{r}
poprov <- mp$data[[3]]
colnames(poprov)[4] <- "Po_prev"

pvprov <- mp$data[[2]]
colnames(pvprov)[4] <- "Pv_prev"
  

plotObj <- dplyr::bind_cols(poprov, pvprov) %>% 
  ggplot(aes(x=Po_prev, y=Pv_prev, size = n)) +
  geom_point(aes(colour = adm1name)) +
  geom_smooth(method="loess", se=F, colour = "red") +
      ggtitle("Povlae versus Pvivax Province Prevalence") + ylab("Pv Prevalence") + xlab("Po Prevalence") +
  vivid_theme

plotly::ggplotly(plotObj)

```
####

### By Cluster
#### _Pf_ versus _Pv_ Prevalence  {.tabset .tabset-fade .tabset-pill}
Points are scaled by size of province (and color of province). Loess curve in red. Cluster filtered for both 0s. 
```{r}
pfclust <- mp$data[[4]]
colnames(pfclust)[4] <- "Pf_prev"

pvclust <- mp$data[[5]]
colnames(pvclust)[4] <- "Pv_prev"
  

plotObj <- dplyr::bind_cols(pfclust, pvclust) %>% 
#  dplyr::filter(!(Pf_prev == 0 & Pv_prev == 0)) %>% 
  ggplot(aes(x=Pf_prev, y=Pv_prev, size = n)) +
  geom_point(color = "#a6bddb") +
  geom_smooth(method="loess", se=F, colour = "red") +
      ggtitle("Pfalciparum versus Pvivax Cluster Prevalence") + ylab("Pv Prevalence") + xlab("Pf Prevalence") +
  vivid_theme

plotly::ggplotly(plotObj)

```

#### _Po_ versus _Pv_ Prevalence
```{r}
poclust <- mp$data[[6]]
colnames(poclust)[4] <- "Po_prev"

pvclust <- mp$data[[5]]
colnames(pvclust)[4] <- "Pv_prev"
  

plotObj <- dplyr::bind_cols(poclust, pvclust) %>% 
#  dplyr::filter(!(Po_prev == 0 & Pv_prev == 0)) %>% 
  ggplot(aes(x=Po_prev, y=Pv_prev, size = n)) +
  geom_point(color = "#a6bddb") +
  geom_smooth(method="loess", se=F, colour = "red") +
      ggtitle("Pfalciparum versus Povale Cluster Prevalence") + ylab("Pv Prevalence") + xlab("Po Prevalence") +
    vivid_theme

plotly::ggplotly(plotObj)

```
#### 






