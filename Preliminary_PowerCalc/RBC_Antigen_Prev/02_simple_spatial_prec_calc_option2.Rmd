---
title: "RBC Antigen/Mutation Prevalence Mapping 'Power' Calculations"
author: "Nicholas F. Brazeau"
date: "`r format(Sys.time(), '%B %d, %Y')`"
editor_options: 
  chunk_output_type: console
runtime: shiny
output: html_document
---

```{r housekeeping, echo = FALSE, warning=F, message=F, results='asis'}
# tidy
library(tidyverse)
# spatial
library(sf)
# stats
library(survey)
#graphing
library(gridExtra)

##----------------------------------##
##            Read-In Data          ## 
##----------------------------------##
load("~/Documents/GitHub/VivID_PhD_Thesis/Preliminary_PowerCalc/RBC_Antigen_Prev/data.RData")

```


# Goal 
The purpose of this script is to determine the precision afforded by the different levels of sampling the **DHS DRC-II Adult Dataset**. 

# Prior Distributions for Allele Frequencies
### Duffy Genotypes
The prior distributions for Duffy-Genoytpes are based on the results from [Howe et al. 2011](https://www.nature.com/articles/ncomms1265). This is a Bayesian geostatistical model based on "821 spatially unique data points of Duffy blood type ... represented a total of 131,187 individuals sampled, 17.8% of whom were surveyed on the African continent (Table 1). Of this total, 536 surveys were geopositioned as points (â‰¤25 km2), and 285 mapped as polygon centroids." **None of the spatial data points are from the DRC based on Fig 2**. Still widely considered the best resource for Duffy-Genotypes and because this was Bayesian, the uncertainty is expressed nicely such that it works with the model I am building below well.   
In addition, the recent review by [Hoher et al. 2017](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC5770319/) suggests that Duffy-ES is fixated across the continent. However, they do note there is some variation among Sudanese individuals, which may have migrated to the DRC in recent years.  
  
**The population allele frequency prior will be 80-100%**. 

### Hemoglobinopathies 
Prior distributions for hemoglobinopathy genotypes are based on the result from [Tshilolo et al. 2009](https://www.ncbi.nlm.nih.gov/pubmed/19103857), [Piel et al. 2010](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3060623/), [Piel et al. 2013](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3628164/), and [Williams et al. 2012](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3426822/).

#### HbS
Of these, [Piel et al. 2010](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3060623/) uses data from [MalariaGEN](https://www.malariagen.net/) and a Bayesian statistical approach that is the best.
  
**The population allele frequency prior will be 8-20%**. 

#### HbC
Again [Piel et al. 2013](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3628164/) is using data from [MalariaGEN](https://www.malariagen.net/) and a Bayesian statistical approach that is best. Of note, there may be cases of HbC in Ituri, Haut-Uele, or North Kivu area.
  
**The population allele frequency prior will be 0-2.5%**. 

#### G6PD
Using [Howes et al. 2012](http://journals.plos.org/plosmedicine/article?id=10.1371/journal.pmed.1001339), which is using the same Bayesian statistical approach above.
  
**The population allele frequency prior will be 1-40%**. 



## Sampling Selection
```{r surveywts, echo = FALSE, warning=F, message=F, results='asis'}
wtres <- glm(pv_pos ~ 1, 
             data=prelim, 
             weights = sampleweight,
             family=binomial(link = "identity"))


```
We identifed 579 cases by RT-PCR -- _subject to change (with confirmatory assay/data cleaning)_. Overall, there is a `r round(broom::tidy(wtres)[2], 2)` weighted prevalence of _P. vivax_ and a `r round(mean(prelim$pv_pos, na.rm=T),2)` raw prevalence of _.P vivax_. I am taking all of these cases in because we need to determine the Duffy Phenotype for all Pv cases. We also want to have a group of non-cases to determine the underlying Duffy Phenotype in the total population. **Therefore, what we really want is a subset of the DHS that is populationally representative of the DRC DHS that includes all of the cases and subset of non-cases**. Overally, cases will have to be weighted and non-cases will have to be weighted to return to the original "N" denominator. This is possible because we have a sampling fraction (because we know who we have sampled from the "true population" based on the DHS sampling weights).


## Selection Probabilities 
**Overview**: Using a binomial likelihood with the prior distributions to run the simulations. 
$P(S=1 \mid C = 0) = rand(n)$ for non-cases. 
$P(S=1 \mid C = 1) = 1$, where all cases are included. 

## Sampling Fractions to Original Denominator
Given that we have, $P(S=1 \mid C)$, and we can use this to get a sampling fraction, $F$, such that $$P(F \mid C ) = \dfrac {1}{n} \sum_{s}^{} 1[S=1 \mid C=c]  $$,  
In this situation we have a sampling fraction for cases ($C=1$) and non-cases ($C=0$).

To find the prevalence of a given mutation (i.e. Duffy, HbS, etc.), $Y$, we can use the sampling fraction to recreate the overall/underlying prevalence that would have resulted if we sampled everyone:   

 $$E[Y] = \sum_{f}^{} E[Y \mid F=f, C=C] \cdot P(F=f, C=C)$$

where $E[Y(X=x)]$ is the prevalence of the mutation. 

 <!-- START SHINY CODING HERE  -->
 
```{r echo = FALSE, warning=F, message=F, results='asis'}

selectInput("genotype", label = "Red Blood Cell Antigen or Mutation",
              choices = c(FYBES = "duffy", 
                          HbS="hbs", 
                          HbC="hbc", 
                          G6PD = "g6pd"))


conditionalPanel(
      condition = "input.genotype == 'duffy'",
      selectInput("duffyn", label = "Number of Samples to Include:",
              choices = seq(from = 1e2, to=3e3, by=1e2), selected = 500),
      sliderInput("duffypAF", label = "Mutatation Frequency (Prior)",
              min = 0.8, max = 1, value = 0.9, step = 0.025)
   )
   
conditionalPanel(
      condition = "input.genotype == 'hbs'",
      selectInput("hbsn", label = "Number of Samples to Include:",
              choices = seq(from = 1e2, to=3e3, by=1e2), selected = 500),
      sliderInput("hbspAF", label = "Mutatation Frequency (Prior)",
              min = 0.08, max = 0.2, value = 0.1, step = 0.01)
   )
   
      conditionalPanel(
      condition = "input.genotype == 'hbc'",
      selectInput("hbcn", label = "Number of Samples to Include:",
              choices = seq(from = 1e2, to=3e3, by=1e2), selected = 500),
      sliderInput("hbcpAF", label = "Mutatation Frequency (Prior)",
              min = 0, max = 0.025, value = 0.01, step = 0.001)
   )
      
conditionalPanel(
      condition = "input.genotype == 'g6pd'",
      selectInput("g6pdn", label = "Number of Samples to Include:",
              choices = seq(from = 1e2, to=3e3, by=1e2), selected = 500),
      sliderInput("g6pdpAF", label = "Mutatation Frequency (Prior)",
              min = 0.01, max = 0.4, value = 0.2, step = 0.05)
   )


### FUNCTION WORK
simdat <- function(nsize, pallele){
    dhs13_short$Sprob <- dhs13_short$sampleweight/sum(dhs13_short$sampleweight)
    rsamp <- sample(x=dhs13_short$barcode, size=nsize, replace = F, prob = dhs13_short$Sprob)
    dhs13_sub <- dhs13_short %>% 
      dplyr::filter(barcode %in% rsamp)
    dhs13_sub$mut <- rbinom(n = length(rsamp), size=1, prob = pallele)
    return(dhs13_sub)
  }


genotypelvl <- reactive({ input$genotype })




```
  
     
       
  
## Map the DRC
```{r sampling, echo = FALSE, warning=F, message=F, results='asis'}

renderPlot({ withProgress(message = 'Making plot', {

  switch(genotypelvl(), 
         duffy={
           dhs13_sub <- simdat(nsize = input$duffyn, pallele = input$duffypAF)
           },
         hbs={
           dhs13_sub <- simdat(nsize = input$hbsn, pallele = input$hbspAF)
           },
        hbc={
           dhs13_sub <- simdat(nsize = input$hbcn, pallele = input$hbcpAF)
           },
        g6pd={
           dhs13_sub <- simdat(nsize = input$g6pdn, pallele = input$g6pdpAF)
        }
  )
        

dhs13_sub <- dhs13_sub %>% 
  dplyr::mutate(case_fraction = 1) %>% 
  dplyr::mutate(noncase_fraction = nrow(dhs13_sub[dhs13_sub$pv_pos==0, ]) / nrow(dhs13_short[dhs13_short$pv_pos==0, ]) ) %>% 
  dplyr::mutate(overallwt = ifelse(c(pv_pos == 0 | is.na(pv_pos)), 
                                  sampleweight * (1/noncase_fraction),
                                  sampleweight * (1/case_fraction)
                                  )) 

dhs13_sub_n <- dhs13_sub %>% 
  dplyr::group_by(shnprovin) %>% 
  summarise(n=n(),
            wtn = sum(overallwt))

design <- survey::svydesign(ids=dhs13_sub$barcode,
                              weights=dhs13_sub$overallwt,
                              data=dhs13_sub)
  
dhs13_sub_sum <- survey::svyby(~mut,~shnprovin,design,survey::svymean)
  
dhs13_sub_sum <- dhs13_sub_sum %>% 
  dplyr::left_join(x=., y=dhs13_sub_n, by = "shnprovin") %>% 
  dplyr::left_join(x=., y=provdict, by = "shnprovin") %>% 
  dplyr::mutate(NAME_1 = provname) %>% 
  dplyr::select(-c(provname)) %>% 
  dplyr::mutate(wtL95CI = mut - 1.96*se) %>% 
  dplyr::mutate(wtU95CI = mut + 1.96*se) %>% 
  dplyr::mutate(CLdiff = wtU95CI - wtL95CI) %>% 
  mutate_if(is.numeric, funs(round(., 2)))


# setup
dhs13_mapdf <- DRCprov %>% 
  dplyr::left_join(x=., y = dhs13_sub_sum, by="NAME_1")


  
plotObj <- ggplot() + 
  geom_sf(data=dhs13_mapdf, aes(fill = CLdiff)) +
 scale_fill_gradientn("Mutation \n CI Difference", colours = c("#d0d1e6", "#3690c0", "#253494")) +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(), 
        panel.background = element_blank(),
        panel.border = element_blank(), 
        plot.title =  element_blank(),
        axis.ticks = element_blank(),
        axis.text.y = element_blank(),
        axis.title.y = element_blank(),
        axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        legend.position = "bottom",
        legend.title = element_text(size=16, family = "Arial", face="bold"),
        legend.title.align=0.5,
        legend.text = element_text(size=14, family = "Arial", face="bold", hjust=0.5, vjust=0.5, angle=90)
  )

  tt2 <- ttheme_default(core = list(fg_params=list(cex = 0.9)),
                        colhead=list(fg_params = list(cex=0.9)))
  tbl <- gridExtra::tableGrob(dhs13_sub_sum, rows=NULL, theme = tt2)
  tbl$widths <- unit(rep(1/(ncol(tbl)), ncol(tbl)), "npc")
  tbl$heights <- unit(rep(1/(nrow(tbl)), nrow(tbl)), "npc")
          
  
    gridExtra::grid.arrange(plotObj, tbl,
                            ncol=2)


  }) # end of progress bar
  
})

blank <- grid::rectGrob(gp=grid::gpar(col="white")) # make a white spacer grob
grid::grid.draw(blank)
```
